---
title: "ETC5521 Assignment 2"
subtitle: "Beach Volleyball Statistics"
team: [emu]
author1:
  - [Justin Thomas]
  - [Mayunk Bharadwaj]
author2:
  - [Abhishek Sinha]
  - [Yiwen Zhang]
date: "`r Sys.Date()`"
bibliography: references.bib
biblio-style: authoryear-comp
output: 
  bookdown::html_document2:
   citation_package: biblatex
   toc: TRUE
---

[This assignment is for ETC5521 Assignment 2 based on Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author1)`.  and revised by  `r knitr::combine_words(rmarkdown::metadata$author2)`.]{style="color:#006DAE;"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(ggplot2)
library(tidyverse)
library(plotly)
library(kableExtra)
library(gridExtra)
library(bookdown)
library(lubridate)
```


# Introduction and Motivation

Using the data provided on the 'tidytuesday' platform, our **primary** question is to identify the characteristics of a winning beach volleyball team for both males and females. 

We believe that there might be differences in characteristics for a winning team compared to a losing team because of, for example, prevalence of beach volleyball in certain countries. Also, we theorize that taller and younger players may potentially be better at beach volleyball because of the competitive advantage they may have over shorter and more seasoned players.

Therefore, the secondary questions that will help us answer our primary question are:

- Which countries have the most winning players?
- What is the average age of players on a winning team?
- What is the average height of players on a winning team?

Furthermore, We will further explore the individual qualities of individual players in the team to identify the most successful player and the most successful combination. In addition to the physiological quality (height, age) and technical factors, we will also study whether the winning team will be affected by the home advantage. 

After studying the characteristics of the winning team, we will also be very curious about an interesting question. Although the winning team is likely to be a strong team (high ranking ), is there any situation that the low ranking team defeats the high ranking team?
So, we add four additional questions to complete this analysis:

- Looking into the FVIB circuit, is there any home advantage for winning players?
- Is there any low ranking team beat higher ranking team?
- What combination of the players are most successful and have teamed up for the greatest number of matches in both the volleyball circuits?
- Who are the most successful players in beach volleyball and how they have evolved over time and their skills pattern?

In the following report, the reader will be able to find a description and information about the source and limitations of the data; information on how the data was cleaned; an analysis that will answer the above questions and a conclusion.

## Limitations of Data Analysis

While going through the dataset, we found that the data was incomplete because there were multiple 'NA' values for individual player performance statistics. As such, observations which featured 'NA' values had to be removed as they were unlikely to be helpful in our analysis. Due to this, the sample size will be reduced, which means that the accuracy of the research results may be affected to a certain extent.

# Data description

```{r data-read-in, include=FALSE,cache=TRUE}
vb_matches <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-19/vb_matches.csv', guess_max = 76000)
```

## Questions

**Primary Question**

What are the characteristics of a winning beach volleyball team for both males and females?

**Secondary Questions**

- Which countries have the most winning players?
- What is the average age of players on a winning team and how does it compare with a losing team?
- What is the average height of players on a winning team and how does it compare with a losing team?

**Additional Questions for Assignment 2**

- Looking into the FVIB circuit, is there any home advantage for winning players?

- Is there any low ranking team beat higher ranking team?

- What combination of the players are most successful and have teamed up for the greatest number of matches in both the volleyball circuits?

- Who are the most successful players in beach volleyball and how they have evolved over time and their skills pattern?

## Explanation of data being used

This data set provides beach volleyball statistics for men's and women's matches at two major tournaments, the Fédération Internationale de Volleyball (FIVB) Beach Volleyball World Championships and the Association of Volleyball Professionals (AVP) tour. The matches are played with teams of 2. In this data set, tournament information, player information, player performance statistics and match results are recorded. The data provided ranges from September 2000 to August 2019 and it has been collected by the data recorded at the tournaments. 

The original data source created by Adam Vagner had initial data recorded from September 2000 to July 2017, however it has been periodically updated with the most recent update coming in May 2020. This can be found at this website on Github.[@bigtimestats]

The structure of the data set is:

- Rows: 76756
- Columns: 65
- Data types: Character, Numeric, Data and Difftime  

There are 65 variables in this data set:

```{r}
vb_matches %>%
  names() %>%
  as_tibble() %>%
  rename(`Variable Name`=value) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("hover", "striped")) %>%
  scroll_box(width = "100%", height = "400px")
```

## Data Cleaning

Our data was already in tidy format, so we did not have much cleaning to do. However in order to conduct our analysis, we have tidied the data set by removing variables that are not pertinent to answer our questions or include too many missing values.

```{r tidy-data, include=FALSE}
vb_matches <- vb_matches %>% select(-duration:-l_p2_tot_digs) %>% select(c(-tournament, -match_num)) %>% mutate(w1_birthyear = year(w_p1_birthdate), w2_birthyear = year(w_p2_birthdate), l1_birthyear = year(l_p1_birthdate), l2_birthyear = year(l_p2_birthdate)) 

vb_matches <- vb_matches %>% mutate(w_p1_age = year - w1_birthyear, w_p2_age = year - w2_birthyear, l_p1_age = year - l1_birthyear, l_p2_age = year - l2_birthyear) %>% select(c(-w_p1_birthdate, -w_p2_birthdate, -l_p1_birthdate, -l_p2_birthdate, - w1_birthyear, -w2_birthyear, -l1_birthyear, -l2_birthyear))

vb_matches_fivb <- vb_matches %>% filter(circuit == "FIVB")
vb_matches_avp <- vb_matches %>% filter(circuit == "AVP")
```

The methods we have used to tidy our data is as follows:

- We deselected some variables from appearing in the data set and overwrote the original data set with the new tidied data set.

The reason for why we did not include variables such as match duration, or some individual player performance statistics was because it did not fit with answering the first three questions we have laid out. Additionally, majority of the data for these variables were unknown, so it would not have been enough in our additional analysis.

## Description of variables in data set as organised in tidy form 

Variable       | Description
---------------|------------
circuit	       |Either AVP (USA) or FIVB (International)
country	       |Country where tournament played
year	         |Year of tournament
date	         |Date of match
gender	       |Gender of team
w_player1	     |Winner player 1 Name
w_p1_age       |Winner player 1 age
w_p1_hgt	     |Winner player 1 height in inches
w_p1_country	 |Winner player country
w_player2	     |Winner player 2 name
w_p2_age	     |Winner player 2 age
w_p2_hgt	     |Winner player 2 height in inches
w_p2_country	 |Winner player 2 country
w_rank         |Winner team rank
l_player1	     |Losing player 1 name
l_p1_age	     |Losing player 1 age
l_p1_hgt	     |Losing player 1 height in inches
l_p1_country	 |Losing player 1 country
l_player2	     |Losing player 2 name
l_p2_age	     |Losing player 2 age
l_p2_hgt	     |Losing player 2 height in inches
l_p2_country	 |Losing player 2 country
w_rank         |Losing team rank
score	         |Match score separated by a dash and matches separated by a comma, eg 21 points to 12 points is 21-12
num_total      |Number of matches host in every country each year
num_winner     |Number of matches with winners from the host country
win_rate       |Home winning rate
num_rank       |Number of matches with lower ranking team defeat higher one
rank_prop      |Proportion of matches with lower ranking team defeat higher one

## Data sources

The original data is sourced from:
Vagner, A. (2020, July 20). *BigTimeStats/beach-volleyball*. Retrieved August 22, 2020, from https://github.com/BigTimeStats/beach-volleyball

To load the data set, we had to use a GitHub repository that had the data set. The name of this repository is "Tidy Tuesday". The data set was sourced from this repository:
Mock, J. (2020, May 19). *rfordatasciene/tidytuesday*. Retrieved August 22, 2020, from 
https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-19/readme.md


# Analysis and findings


## Which countries have the most winning players?

For both the AVP and FIVB tournaments, a team consists of 2 players. Each player in the team either comes from the same country or they can come from different countries. Thus, in this section, our analysis focuses on finding the countries that had the most number of winning teams. This will help us find the countries that had the most winning players. 

```{r arrange-desc, include=FALSE}
country <- vb_matches %>% distinct(w_player1, w_p1_country, w_player2, w_p2_country) %>%                 group_by(w_p1_country, w_p2_country) %>% 
                tally() %>% drop_na() %>% arrange(desc(n))

```

```{r rename-variables, include=FALSE}
country <- country %>% rename(`Player_1_country` = w_p1_country,
                     `Player_2_country` = w_p2_country,
                     `Number_of_teams` = n)

country_fivb <- vb_matches_fivb %>% distinct(w_player1, w_p1_country, w_player2, w_p2_country) %>% group_by(w_p1_country, w_p2_country) %>% 
                tally() %>% arrange(desc(n)) %>% rename(`Player_1_country` = w_p1_country,
                     `Player_2_country` = w_p2_country,
                     `Number_of_teams` = n)
```

In order to find our answer to this question, we first did some data wrangling to get the data set up for analysis. Then we followed the steps outlined below:

- Firstly, find the distinct players in the variables w_p1_country and w_p2_country. This is to ensure we don't get multiple rows of the same team with the same combination of player 1 and player 2. 
- After getting distinct players, we grouped the players by their respective countries.
- Following this, we use the tally() function to count up the total number of teams by countries and dropped any rows that had no values in them. 
- This gave us a list of all the participating countries with a total count of winning teams per country.
- We rearranged the data to show the total count in descending order and we also renamed the variables to make it more meaningful.
- Lastly, we saved this as a new data set called "country" to be used later on.

```{r plot-teams, echo=FALSE, fig.align = 'center', fig.cap="Top 20 countries with the most winning teams"}
p1 <- ggplot(country %>% head(20), aes(`Number_of_teams`, reorder(`Player_1_country`, +`Number_of_teams`))) +
  geom_bar(stat = "identity", fill = "steelblue") +
  xlab("Number of teams") +
  ylab("Country") +
  ggtitle("Top 20 countries with the most winning teams in FIVB & AVP circuits") +
  theme(panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "grey93"))

ggplotly(p1, tooltip = "x")
```

```{r plot-teams-fivb, echo=FALSE, fig.align = 'center', fig.cap="Top 20 countries with the most winning teams in FIVB Circuit"}
p2 <- ggplot(country_fivb %>% head(20), aes(`Number_of_teams`, reorder(`Player_1_country`, +`Number_of_teams`))) +
  geom_bar(stat = "identity", fill = "steelblue") +
  xlab("Number of teams") +
  ylab("Country") +
  ggtitle("Top 20 countries with the most winning teams in FIVB circuit") +
  theme(panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "grey93"))

ggplotly(p2, tooltip = "x")
```


Figure \@ref(fig:plot-teams) shows the top 20 countries with the most number of winning teams. We can see that the United States was the most dominating country with a total of `r country$Number_of_teams[1]` winning teams. This means that at minimum `r (country$Number_of_teams[1])*2` players came from the United States and won. In distant second place, Brazil had `r country$Number_of_teams[2]` winning teams, and so `r (country$Number_of_teams[2])*2` Brazilian players won matches where both players in the team came from Brazil. In a close third place, Germany triumphed with `r country$Number_of_teams[3]` winning teams comprising of `r (country$Number_of_teams[3])*2` players. The remaining 17 teams in this plot ranged from having `r country$Number_of_teams[4]` winning teams to `r country$Number_of_teams[20]` winning teams.

The clear winner here is United States and we can conclude that majority of the winning players in the AVP and FIVB tournaments hail from the United States.

But if we consider Figure \@ref(fig:plot-teams-fivb) we can notice a different picture. FIVB circuit is the world championships where countries play against each other instead of players centric AVP. Looking at this plot we can see that in world championships teams from countries like Brazil give strong competition to U.S.

We decided to dig further into United States. Although there were `r country$Number_of_teams[1]` teams where both players in each team came from the United States, there were instances were 1 player came from the United States and another player came from a different country. This following section takes a look at the different countries that partnered with the United States.

```{r USA, include=FALSE}
USA <- country %>% filter(`Player_1_country` == "United States" | `Player_2_country` == "United States") 
```

In order to find the different countries that partnered with the United States, we followed the steps outlined below:

- First, we filtered the rows from the "country" data set so that values from "Player 1 country" variable are "United States" or values from "Player 2 country" variable are "United States". 

This gave us a list of all the different country combinations where either player 1 or player 2 came from the United States and the other non-USA player's country.


```{r USA-combos, echo=FALSE}
USA %>% head(20) %>% kable(caption = "Different combinations of countries that partnered with the United States") %>% kable_styling(bootstrap_options = c("hover", "striped")) 
```


Table \@ref(tab:USA-combos) shows 20 different country combinations, which is only a subset of the different countries that partnered with the United States. In total there were 66 different combinations. 

Apart from both players coming from the United States, 44 different teams had player 1 come from the United States and player 2 come from Brazil. 34 teams had player 1 come from Poland and player 2 come from the United States. 

From looking at the rest of the table, we can see just how popular the United States is as a competing country in volleyball tournaments. It not only registers in tournaments where both players come from the United States, but it also registers where only 1 player in the team comes from the United States and partners with a player from a different country.


## What is the average age of a winning team and how does it compare with a losing team?

```{r age}
#selecting only relevant variables for analysis
age <- vb_matches %>%
  select(gender, w_p1_age,w_p2_age,l_p1_age,l_p2_age)

#generating five-number summary stats for male player ages
age_summary_male <- age %>%
  filter(gender=="M") %>%
  summary()

age_summary_male <- as.data.frame(age_summary_male)

#generating five-number summary stats for female player ages
age_summary_female <- age %>%
  filter(gender=="W") %>%
  summary()

age_summary_female <- as.data.frame(age_summary_female)
```

N.B. For the method used to complete this analysis, please refer to the commentary included within the code chunks.

The average age for male winning players 1 and 2 are `r age_summary_male$Freq[11]` and `r age_summary_male$Freq[18]` respectively. The average age for male losing players 1 and 2, on the other hand, are `r age_summary_male$Freq[25]` and `r age_summary_male$Freq[32]` respectively. There is no obvious bias to winning and losing due to age - as the average age for losers and winners is about the same. 

This might tell us something, however, about the average age of participation in professional male volleyball. If we plot every age of, for instance, male winning player 1 (Figure \@ref(fig:age-2)) and male losing player 2 (Figure \@ref(fig:age-3)) as examples, we see that the most commonly occurring ages are in the late 20s (28-29 year of age). Therefore, it is reasonable to infer that male volleyball players - due to the high levels of participation at those ages -- hit their peak in their late 20s.

Now, let's consider women's volleyball. The average age for female winning players 1 and 2 are `r age_summary_female$Freq[11]` and `r age_summary_male$Freq[18]` respectively. The average age for female losing players 1 and 2 are `r age_summary_male$Freq[25]` and `r age_summary_male$Freq[32]` respectively. As was the case with the male game, age does not seem to strongly influence winning. However, it is interesting to note that their is a slight difference in average age of winning and losing players between the genders. If we take a look at the average age of winning player 2 in Figure \@ref(fig:age-4), we can see that the average age of winning player 2 is less for females than males. Similarly, if we consider the average age of losing player 1 in Figure \@ref(fig:age-5), we can see that the average age is also less for females than it is for males.


```{r age-2, fig.cap="Ages of Male Winning Player 1"}

#creating histogram for male winning player 1 ages
age_plot <- age %>%
  filter(gender=="M") %>%
  ggplot() +
  geom_histogram(aes(w_p1_age),binwidth = 1, fill="steelblue") +
  xlab("Ages") +
  ylab("")  +
  theme(panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "grey93"))+
  theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank(),
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold")) 

ggplotly(age_plot, tooltip = "x")
```

```{r age-3, fig.cap="Ages of Male Losing Player 2"}

#creating histogram for male losing player 2 ages
age_plot_2 <- age %>%
  filter(gender=="M") %>%
  ggplot() +
  geom_histogram(aes(l_p2_age),binwidth = 1, fill="steelblue") +
  xlab("Ages") +
  ylab("") +
  theme(panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "grey93")) +
  theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank(),
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold")) 

ggplotly(age_plot_2, tooltip = "x")
```

```{r age-4, fig.cap="Ages of Winning Player 2 by gender"}

#creating boxplot for age gap between genders for winning player 2
age %>%
  ggplot(aes(w_p2_age)) +
  geom_boxplot(fill="steelblue") +
  facet_wrap(~gender) +
  coord_flip() +
  theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank(),
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"))  +
  xlab("Ages") +
  theme(panel.grid.major = element_blank()) +
 theme(plot.background = element_rect(fill = "grey93",size = 8),
        plot.margin = unit(c(1, 2 ,1, 2), "cm"))

```

```{r age-5, fig.cap="Ages of Losing Player 1 by gender"}

#creating boxplot for age gap between genders for losing player 1
age %>%
  ggplot(aes(l_p1_age)) +
  geom_boxplot(fill="steelblue") +
  facet_wrap(~gender) +
  coord_flip() +
  theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank(),
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold")) +
  xlab("Ages") +
  theme(panel.grid.major = element_blank()) +
 theme(plot.background = element_rect(fill = "grey93",size = 8),
        plot.margin = unit(c(1, 2 ,1, 2), "cm"))

```


## What is the average height of a winning team and how does it compare with a losing team?

```{r height-1}

#selecting relevant variables for analysis
height <- vb_matches %>%
  select(gender,w_p1_hgt,w_p2_hgt,l_p1_hgt,l_p2_hgt)

#generating female height summary statistics 
height_summary_female <- height %>%
  filter(gender=="W") %>%
  summary()

height_summary_female <- as.data.frame(height_summary_female)

#generating male height summary statistics
height_summary_male <- height %>%
  filter(gender=="M") %>%
  summary()

height_summary_male <- as.data.frame(height_summary_male)

```

N.B. For the method used to complete this analysis, please refer to the commentary included within the code chunks.

The average height for female winning players 1 and 2 are `r height_summary_female$Freq[11]` and `r height_summary_female$Freq[18]` inches respectively. The average height for female losing players 1 and 2 are `r height_summary_female$Freq[25]` and `r height_summary_female$Freq[32]` inches respectively. Although the average height for the losing players is less than the height of winning players, it is not a huge difference.

The average height for male winning players 1 and 2 are `r height_summary_male$Freq[11]` and `r height_summary_male$Freq[18]` inches respectively, compared to the height for losing players 1 and 2 of `r height_summary_male$Freq[25]` and `r height_summary_male$Freq[32]` inches respectively. Consider Figures \@ref(fig:male-height-diff-boxplot) and \@ref(fig:female-height-diff-boxplot), which display the difference in heights between male winning and losing players 1 (Fig. \@ref(fig:male-height-diff-boxplot)) and male winning and losing player 2 (Fig. \@ref(fig:female-height-diff-boxplot)). In both situations, the means in difference in height are pretty evenly centred around 0. so we probably can't say height difference effects winning a volleyball game. We can however say that male volleyball participants are generally taller than female volleyball participants although through common sense we know this phenomenon is not unique to just volleyball.

```{r height-diff}

#creating two new variables measuring difference in height between winning and losing players
height_diff <- vb_matches %>%
  mutate(diff_hgt_p1=w_p1_hgt-l_p1_hgt,
         diff_hgt_p2=w_p2_hgt-l_p2_hgt)
```

```{r male-height-diff-boxplot, fig.cap="Difference in Heights of Male Player 1"}

#creating boxplot for difference in height in male player 1s
height_diff %>%
  filter(gender=="M") %>%
  ggplot(aes(diff_hgt_p1)) +
  geom_boxplot(fill="steelblue") +
  coord_flip() +
  theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank()) +
  xlab("Difference in Height (inches)")  +
  theme(panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "grey93",size = 8),
        plot.margin = unit(c(1, 2 ,1, 2), "cm"))+
  theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank(),
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold")) 
```

```{r female-height-diff-boxplot, fig.cap="Difference in Heights of Male Player 2"}

#creating box-plot for difference in height in male player 2s
height_diff %>%
  filter(gender=="M") %>%
  ggplot(aes(diff_hgt_p2)) +
  geom_boxplot(fill="steelblue") +
  coord_flip() +
  theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank()) +
  xlab("Difference in Height (inches)")  +
  theme(panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "grey93",size = 8),
        plot.margin = unit(c(1, 2 ,1, 2), "cm")) +
  theme(
  axis.text.x = element_blank(),
  axis.ticks = element_blank(),
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold")) 
```


## Looking into the FVIB circuit, is there any home advantage for winning team?

In team sports, the term home advantage describes the benefit that the home team is said to gain over the visiting team. This is because the home team will be more adaptable to the weather, temperature and other natural factors in the competition area. Additionally, there will be no jet lag problem, and there will also be a sense of security on the psychological level. Therefore, home advantage is a frequently mentioned topic in sports competitions. This time is no exception, we will also be curious whether the winning team of beach volleyball will have home advantage, which will be analyzed as followed.

Firstly, since the host country and contestant's country in AVP competition is almost the United States, it is meaningless to discuss this issue, so I only choose the data of FVIB competition as the object. Then let's see the home winning rate regardless of gender. I select the observations that has country where tournament played equal the country where winner is from. And then compute the number of these matches and save it as variable "num_winner". After that, I compute the total number of matched host in every country each year and save it as variable "num_total". Next, I join these two tables together to calculate the winning rate. Finally, I divide "num_winner" by "num_total" to get the winning rate regardless gender.

After getting the results, I make a bar plot to show this with a descending order.

```{r}
vb_matches_FIVB_country <- vb_matches_fivb %>%
  select(`country`,`w_p1_country`,`w_p2_country`,`l_p1_country`,`l_p2_country`) %>%
  filter(country == w_p1_country) 

# count the number of matches with winners from the host country
FIVB_country_win <- vb_matches_FIVB_country %>%
  count(w_p1_country) %>%
  setNames(c("country","num_winner"))

# count the number of matches host in every country each year
FIVB_country <- vb_matches_fivb %>%
  count(country) %>%
  setNames(c("country","num_total"))

#join the data 
FVIB_win_prop = left_join(x = FIVB_country, y = FIVB_country_win, by="country") %>%
  mutate(win_rate = (num_winner/num_total)*100) %>%
  arrange(desc(win_rate))
```

Looking into Figure \@ref(fig:plot-win), it can be observed that in all the eight years, although team of `r FVIB_win_prop$country[1]` has the highest winning rate at `r FVIB_win_prop$win_rate[1]`%, all the winning rate at home is less than fifty percentage, that is to say, the winning rate at home is not higher than that at away, which shows that the home advantage is not obvious in FVIB competition.

```{r plot-win, fig.cap="Home winning rate for all teams in FIVB"}
 pcor <- ggplot(FVIB_win_prop, aes(x=reorder(country,win_rate), y =  win_rate)) +
  geom_bar(position = 'dodge',stat="identity",fill = '#619CFF') +
   #geom_text(aes(label= round(win_rate)) , position=position_dodge(width=1),hjust = 0.000001)+
  ggtitle("Home winning rate for all teams in FIVB") +
  theme(plot.background = element_rect(fill = "#ffffff")) +
  scale_y_continuous(breaks=NULL) +
  xlab("country")+
  ylab("proportion")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank(),
        axis.text=element_text(size=7),
        axis.title=element_text(size=12,face="bold")) +
  
  coord_flip() 

ggplotly(pcor)
```

```{r}
win_country_W <- vb_matches_fivb %>%
  select(`country`,`gender`,`w_p1_country`,`w_p2_country`,`l_p1_country`,`l_p2_country`) %>%
  filter(country == w_p1_country) %>%
  filter(gender == "W")

# count the number of matched with winners from the host country
FIVB_win_W <- win_country_W %>%
  count(w_p1_country) %>%
  setNames(c("country","num_winner"))

# count the number of matches host in every country each year
FIVB_country_W <- vb_matches_fivb %>%
  filter(gender == "W") %>%
  count(country) %>%
  setNames(c("country","num_total"))

#join the data 
win_prop_W = left_join(x = FIVB_country_W, y = FIVB_win_W, by="country") %>%
  mutate(win_rate = (num_winner/num_total)*100) %>%
  arrange(desc(win_rate))
```

Although the home court advantage is not obvious for the winning team in general, is there any difference between the winning teams of different genders?

Then we comes to women's team. On the basis of the previous part of the method, I added gender screening with screening the teams only for female gender, and calculated the home winning rate, then displayed the results in Figure \@ref(fig:plot-W). It can be seen that with `r win_prop_W$country[1]` having the highest rate at `r win_prop_W$win_rate[1]`%, all of the teams don't have rates over fifty percent, quite same as the general situation. That indicates that home advantage is still not obvious in women's team.

```{r plot-W, fig.cap="Home winning rate for Woman"}
pw <-  ggplot(win_prop_W,
       aes(country,win_rate, fill = country)) +
  geom_bar(stat = "identity")+
  ggtitle("Home winning rate for Woman") + 
  #scale_fill_brewer(palette = "Blues")+
  ylab("proportion") +
  xlab("country") +
  theme(#axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

ggplotly(pw)
```


```{r}
win_country_M <- vb_matches_fivb %>%
  select(`country`,`gender`,`w_p1_country`,`w_p2_country`,`l_p1_country`,`l_p2_country`) %>%
  filter(country == w_p1_country) %>%
  filter(gender == "M")

# count the number of matched with winners from the host country
FIVB_win_M <- win_country_M %>%
  count(w_p1_country) %>%
  setNames(c("country","num_winner"))

# count the number of matches host in every country each year
FIVB_country_M <- vb_matches_fivb %>%
  filter(gender == "M") %>%
  count(country) %>%
  setNames(c("country","num_total"))

#join the data 
win_prop_M = left_join(x = FIVB_country_M, y = FIVB_win_M, by="country") %>%
  mutate(win_rate = (num_winner/num_total)*100) %>%
  arrange(desc(win_rate))
```

Using the same method of screening women's teams, the teams whose gender is only male are selected and the winning rate at home is calculated after that. The results are shown in Figure \@ref(fig:plot-M). It is quite interesting that the home advantage is also not obvious in men, even if the highest rate is reached `r win_prop_M$win_rate[1]`% by `r win_prop_M$country[1]`.

```{r  plot-M, fig.cap="Home winning rate for Man"}
pm <-  ggplot(win_prop_M,
       aes(x= country, 
           y = win_rate, fill = country)) +
  geom_bar(stat = "identity") +
  ggtitle("Home winning rate for Man") + 
  ylab("proportion") +
  xlab("country") +
  theme(#axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

ggplotly(pm)
```

General speaking, home advantage is not tenable for the winning team in FVIB tournament, regardless of gender. However, if we look further, we can find that there are both some gaps in graphs of men and women. For example, there is no male team in Korea having a home winning, and there is no female team in Oman gaining home winning either, which may indicate that the strength of men's or women's beach volleyball in these countries is not enough or is not attached much attention to.
But in any case, Brazil has the most home winning rate, although it does not have the most number of winning teams.


## Is there any low ranking team beat higher ranking team?

Through the analysis, we can know that the winning team may be a strong team, but is there any situation that the low ranking team defeats the higher one?
First, I focus on FVIB tournament, and filter the matches in which the low ranking team defeated the higher one for women. And then compute the number of these matches and save it as variable "num_rank" . After that, I compute the total number of matched host in every country each year and save it as variable "num_total". Next, I join these two tables together to calculate the proportion of teams with low ranking but defeating the higher one. Finally, I divide "num_rank" by "num_total" to get the results.Second, I use the same method as above to compute the rate for men.

```{r}
# FVIB  for women 
FVIB_rank_W <- vb_matches_fivb %>%
  filter(w_rank < l_rank) %>%
  filter(gender == "W")

FVIB_rank_count_W <- FVIB_rank_W %>%
  count(country) %>%
  setNames(c("country","num_rank"))

FIVB_country_W <- vb_matches_fivb %>%
  filter(gender == "W") %>%
  count(country) %>%
  setNames(c("country","num_total"))

FVIB_rank_prop_W = left_join(x = FVIB_rank_count_W, y = FIVB_country_W, by="country") %>%
  mutate(rank_prop = (num_rank/num_total)*100) %>%
  arrange(desc(rank_prop))
  
```


```{r}
#FVIB for men
FVIB_rank_M <- vb_matches_fivb %>%
  filter(w_rank < l_rank) %>%
  filter(gender == "M")

FVIB_rank_count_M <- FVIB_rank_M %>%
  count(country) %>%
  setNames(c("country","num_rank"))

FIVB_country_M <- vb_matches_fivb %>%
  filter(gender == "M") %>%
  count(country) %>%
  setNames(c("country","num_total"))

FVIB_rank_prop_M = left_join(x = FVIB_rank_count_M, y = FIVB_country_M, by="country") %>%
  mutate(rank_prop = (num_rank/num_total)*100)  %>%
  arrange(desc(rank_prop))
```

In Figure \@ref(fig:plot-WR), for female,it can be seen that tournament in `r FVIB_rank_prop_W$country[1]` has the most proportion of team defeating teams higher ranking them at about `r max(FVIB_rank_prop_W$rank_prop)`%, and the lowest tournament is in `r FVIB_rank_prop_W$country[44]` at `r min(FVIB_rank_prop_W$rank_prop)`%. Most of the tournaments have over half teams defeating the higher ranked teams.

```{r plot-WR, fig.cap="Low ranking team beat higher ranking team(Woman FVIB)"}
#plot for women in FVIB
pWR <- FVIB_rank_prop_W %>%
  ggplot(aes(x = country, y = rank_prop,
            group = country, color = country)) +
  geom_point() +
  ggtitle("Low ranking team beat higher ranking team(Woman FVIB)") + 
  ylab("proportion") +
  xlab("country") +
  theme(#axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

ggplotly(pWR)
```

Figure \@ref(fig:plot-MR) shows the results of men. The tournament in `r FVIB_rank_prop_M$country[1]` had most proportion, about `r max(FVIB_rank_prop_M$rank_prop)`% teams defeating higher ranked one. The only three that was not over fifty percent are `r FVIB_rank_prop_M$country[43]` ,`r FVIB_rank_prop_M$country[44]`and `r FVIB_rank_prop_M$country[45]` with proportion at `r FVIB_rank_prop_M$rank_prop[43]`% , `r FVIB_rank_prop_M$rank_prop[44]` and `r FVIB_rank_prop_M$rank_prop[45]`%. Similar to women, most tournament for men had over half team defeating higher ranked one.

However, we could also recognize that this proportion of women is greater than that of men for most countries, which indicates that the overall strength of the women's team is stronger than that of the men's team.

```{r plot-MR, fig.cap="Low ranking team beat higher ranking team(Man FVIB)"}
#plot for men in FVIB
pMR <- FVIB_rank_prop_M %>%
  ggplot(aes(x = country, y = rank_prop,
            group = country, color = country)) +
  geom_point() +
  ggtitle("Low ranking team beat higher ranking team(Man FVIB)") + 
  ylab("proportion") +
  xlab("country") +
  theme(#axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

ggplotly(pMR)
```

Then, it comes to the AVP tournament. I use the same method applied in the analysis of FVIB. But in order to display the women and men rate in one plot, I manually create a tibble that only contains the gender and the rate value. As the host country in AVP is all America, I ignore the country variable. I also draw a plot to represent the results.

```{r}
AVP_rank_W <- vb_matches_avp %>%
  filter(w_rank < l_rank) %>%
  filter(gender == "W")

AVP_rank_count_W <- AVP_rank_W %>%
  count(country) %>%
  setNames(c("country","num_rank"))

AVP_country_W <- vb_matches_avp %>%
  filter(gender == "W") %>%
  count(country) %>%
  setNames(c("country","num_total"))

AVP_rank_prop_W = left_join(x = AVP_rank_count_W, y = AVP_country_W, by="country") %>%
  mutate(rank_prop = (num_rank/num_total)*100) 
  
```

```{r}
AVP_rank_M <- vb_matches_avp %>%
  filter(w_rank < l_rank) %>%
  filter(gender == "M")

AVP_rank_count_M <- AVP_rank_M %>%
  count(country) %>%
  setNames(c("country","num_rank"))

AVP_country_M <- vb_matches_avp %>%
  filter(gender == "W") %>%
  count(country) %>%
  setNames(c("country","num_total"))

AVP_rank_prop_M = left_join(x = AVP_rank_count_M, y = AVP_country_M, by="country") %>%
  mutate(rank_prop = (num_rank/num_total)*100) 
```

```{r}
# Make a table to contain the proportion both for men and women
rank_prop_com <- tribble(
  ~gender, ~rank_prop, 
  "W", 51.14613, 
  "M", 50.25072,  
)

```

In Figure \@ref(fig:plot-RA), the bar chart on the left side is the rate of men with the right-side one showing the rate of women team. It can be observed that the rate of men is about `r min(rank_prop_com$rank_prop)`%, and the rate of women is around `r max(rank_prop_com$rank_prop)`%. We can see that in the AVP competition, the gender difference is not obvious. Similarly, more than half of the teams can beat the higher ranked teams.

```{r plot-RA,fig.cap="Low ranking team beat higher ranking team (AVP)"}
pra <- ggplot(rank_prop_com, aes(x=reorder(gender,rank_prop), y =  rank_prop)) +
  geom_bar(stat="identity",fill = 'purple', color = "pink",width=0.3) +
  ggtitle("Low ranking team beat higher ranking team (AVP)") + 
  ylab("Rate") +
  xlab("Gender") +
  theme(#axis.title.x = element_blank(),
        #axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

ggplotly(pra)
```

Generally speaking, the situation that the lower ranked teams beat the higher ranked teams accounts for more than half of the total in both FVIB and AVP tournaments. Therefore, we can say that it is not uncommon for low ranking teams to beat high ranked ones in beach volleyball. It also indirectly indicates that ranking in beach volleyball competition may not fully reflect the strength and winning rate of a team.

## What combination of the players are most successful and have teamed up for the greatest number of matches in both the volleyball circuits?

```{r combos-players, echo=FALSE, include=FALSE}
# most number of combinations

players_comb_fivb_win <- vb_matches_fivb %>% select(w_player1, w_player2)
players_comb_fivb_win <- players_comb_fivb_win %>% rename(player1 = w_player1, player2 = w_player2)
players_comb_fivb_lost <- vb_matches_fivb %>% select(l_player1, l_player2)
players_comb_fivb_lost <- players_comb_fivb_lost %>% rename(player1 = l_player1, player2 = l_player2)
players_comb_fivb <- rbind(players_comb_fivb_win, players_comb_fivb_lost)

players_comb_fivb_total <- players_comb_fivb %>% group_by(player1, player2) %>% tally() %>% arrange(desc(n))

#sum(players_comb_fivb_total$n)

# checking and counting as same, a combination of player1 and player2 present as (player1, player2) at one place and at another as (player2, player1). Same combination but different order.

players_comb_fivb_total_new <- players_comb_fivb_total %>% 
  group_by(player1n = pmin(player1, player2), player2n = pmax(player1, player2)) %>% 
  summarise(n = sum(n)) %>%
  rename(player1 = player1n, player2 = player2n) %>% arrange(desc(n))

#sum(players_comb_fivb_total_new$n)

players_comb_fivb_total_new %>%
  rename(Count = n) %>% head(10) %>% kable(caption = "Different combinations of players that have teamed up for the greatest number of matches in both the volleyball circuits") %>% kable_styling(bootstrap_options = c("hover", "striped")) 
```

Table \@ref(tab:combos-players) shows top 10 different combinations of players that have teamed up for the greatest number of matches in both the volleyball circuits, which is only a subset of the total combinations of players. In total there were 5,613 unique combinations. `r players_comb_fivb_total_new$player1[1]` and `r players_comb_fivb_total_new$player2[1]` partnered up for the most number of times across both FIVB and AVP followed by `r players_comb_fivb_total_new$player1[2]` and `r players_comb_fivb_total_new$player2[2]`.

```{r combos-players-win, echo=FALSE}
# combinations with most wins

players_comb_fivb_win <- players_comb_fivb_win %>% mutate(n = 1)

players_comb_fivb_win_new <- players_comb_fivb_win %>% 
  group_by(player1n = pmin(player1, player2), player2n = pmax(player1, player2)) %>% 
  summarise(n = sum(n)) %>%
  rename(player1 = player1n, player2 = player2n) %>% arrange(desc(n))

#sum(players_comb_fivb_win_new$n)

players_comb_fivb_win_new %>%
  rename(Count = n) %>% head(10) %>% kable(caption = "Different combinations of players that are the most successful") %>% kable_styling(bootstrap_options = c("hover", "striped")) 
```
Table \@ref(tab:combos-players-win) shows top 10 combinations of the players that are most successful in both the volleyball circuits. `r players_comb_fivb_win_new$player1[1]` and `r players_comb_fivb_win_new$player2[1]` is the most successful team across both FIVB and AVP followed by `r players_comb_fivb_win_new$player1[2]` and `r players_comb_fivb_win_new$player2[2]`. 

## Who are the most successful players in beach volleyball and how they have evolved over time and their skills pattern?


# 10 most successful players

#players_comb_fivb_win

#players_comb_fivb_win %>% distinct(player1)

```{r  player-comb, include = FALSE}
players_comb_fivb_win_total_player1 <- players_comb_fivb_win %>% select(player1,n)
players_comb_fivb_win_total_player1 <- players_comb_fivb_win_total_player1 %>% 
  group_by(player1) %>% 
  summarise(n = sum(n)) %>% arrange(desc(n)) %>% rename(player = player1)
#players_comb_fivb_win_total_player1

players_comb_fivb_win_total_player2 <- players_comb_fivb_win %>% select(player2,n)
players_comb_fivb_win_total_player2 <- players_comb_fivb_win_total_player2 %>% 
  group_by(player2) %>% 
  summarise(n = sum(n)) %>% arrange(desc(n)) %>% rename(player = player2)
players_comb_fivb_win_total_player2

players_comb_fivb_win_total <- rbind(players_comb_fivb_win_total_player1, players_comb_fivb_win_total_player2)
```

```{r players-win, echo=FALSE}
players_comb_fivb_win_total%>%
  rename(Matches_Won = n) %>% head(10) %>% kable(caption = "Total Matches won per player") %>% kable_styling(bootstrap_options = c("hover", "striped")) 

#players_comb_fivb_win_total %>% head(10)
```

Table \@ref(tab:players-win) shows top 10 most successful players in both the volleyball circuits combined. `r players_comb_fivb_win_total$player[1]` leads with `r players_comb_fivb_win_total$n[1]` combined wins so far followed by `r players_comb_fivb_win_total$n[2]` and `r players_comb_fivb_win_total$n[3]`. 

```{r player-list,include=FALSE}
#players_list <- players_comb_fivb_win_total %>% head(5) %>% select(player)

players_comb_fivb_win_year_all <- vb_matches_fivb %>% select(year, w_player1, w_player2, l_player1, l_player2)
players_comb_fivb_win_year_win <- vb_matches_fivb %>% select(year, w_player1, w_player2)

#players_comb_fivb_win_year_all
#players_comb_fivb_win_year_win

players_comb_fivb_win_year_all <- players_comb_fivb_win_year_all %>%
  pivot_longer(!year, names_to = "player type", values_to = "player") %>% select(year, player)
players_comb_fivb_win_year_win <- players_comb_fivb_win_year_win %>%
  pivot_longer(!year, names_to = "player type", values_to = "player") %>% select(year, player)

players_comb_fivb_win_year_all <- players_comb_fivb_win_year_all %>% group_by(year, player) %>% tally()
players_comb_fivb_win_year_win <- players_comb_fivb_win_year_win %>% group_by(year, player) %>% tally()

players_comb_fivb_win_year_all <- players_comb_fivb_win_year_all %>% filter(player %in% c("Juliana Felisberta","Emanuel Rego","Alison Cerutti","April Ross","Carolina Salgado")) %>% arrange(player) %>% rename(total_matches = n)

players_comb_fivb_win_year_win <- players_comb_fivb_win_year_win %>% filter(player %in% c("Juliana Felisberta","Emanuel Rego","Alison Cerutti","April Ross","Carolina Salgado")) %>% arrange(player) %>% rename(win_matches = n)

player_best <- merge(x = players_comb_fivb_win_year_all, y = players_comb_fivb_win_year_win, by = c("year","player"), all.x = TRUE)

player_best <- player_best %>% arrange(player)
player_best[is.na(player_best)] <- 0 

player_best
```

```{r growth-time, echo=FALSE, fig.align = 'center', fig.cap="Top 5 successful players growth in terms of win overtime"}
player_best_plot <- player_best %>%
  pivot_longer(c(-year, -player), names_to = "match_type", values_to = "count") 

p <- ggplot(player_best_plot, aes(x=year, y=count, fill=match_type)) +
    geom_bar(stat='identity', position='dodge') + facet_grid(rows = vars(player,size=8)) +
  scale_x_continuous(breaks = seq(2000,2020,20)) +
  theme(
        axis.text=element_text(size=10),
        axis.title=element_text(size=12,face="bold"),
        plot.margin = unit(c(0.5, 0.2, 0.5, 0.2), "cm"))
  

ggplotly(p)
```

Figure \@ref(fig:growth-time) shows the growth of top 5 successful players as identified in table \@ref(tab:players-win). 

# Conclusion

After our analysis, we have concluded that a typical winning male volleyball team most likely has both players originating from the United States, with player one having an average age of `r age_summary_male$Freq[11]` and an average height of `r height_summary_male$Freq[11]` inches with player two having an average age of `r age_summary_male$Freq[18]` and an average height of `r height_summary_male$Freq[18]` inches.

In addition, a typical winning female volleyball team most likely has both players originating from the United States, with player one having an average age of `r age_summary_female$Freq[11]` and an average height of `r height_summary_female$Freq[11]` inches with player two having an average age of `r age_summary_male$Freq[18]` and an average height of `r height_summary_male$Freq[18]` inches.

As for the home advantage, although team of Brazil has the highest winning rate at `r max(FVIB_win_prop$win_rate)`%, all the winning rate at home is less than fifty percentage, that is to say, the winning rate at home is not higher than that at away, which shows that the home advantage is not obvious in FVIB competition regardless of gender. But there does exist some gaps between male and female.

When it comes to the lower ranking team defeat the higher ranking one, first in FVIB circuit, it can be concluded that the most proportions of this for female and male are `r max(FVIB_rank_prop_W$rank_prop)`% by `r FVIB_rank_prop_W$country[1]` and `r max(FVIB_rank_prop_M$rank_prop)`% by `r FVIB_rank_prop_M$country[1]` respectively. Then in AVP circuit,the most proportions of this for female and male are ``r max(rank_prop_com$rank_prop)`%% and `r min(rank_prop_com$rank_prop)`%% all by `r AVP_rank_prop_M$country[1]`. So, it is not uncommon for low ranking teams to beat high ranked ones in beach volleyball. It also indirectly indicates that ranking in beach volleyball competition may not fully reflect the strength and winning rate of a team. Also, gender gap is not obvious on this issue.


# Acknowledgements

Thanks for the contributors of these packages:


- ggpplot2 [@ggplot2]

- tidyverse [@tidyverse]

- kableExtra [@kableExtra]

- bookdown [@bookdown]

- gridExtra [@gridExtra]

- plotly [@plotly]

- lubridate [@lubridate]

# References


